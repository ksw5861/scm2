<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yedam.scm.order.mapper.ReturnMapper">

  <!-- ==================================== -->
  <!-- 1. 반품 등록 -->
  <!-- ==================================== -->
  <insert id="insertReturn" parameterType="ReturnVO">
    INSERT INTO "RETURN" (
        return_id,
        odetail_id,
        return_qty,
        return_why,
        return_price,
        return_date
        
    ) VALUES (
        next_date_code('RT'),
        #{odetailId},
        #{returnQty},
        #{returnWhy,jdbcType=VARCHAR},
        NVL(#{returnPrice}, 1),
        SYSDATE
       
    )
  </insert>

  <!-- ==================================== -->
  <!-- 2. 반품 목록 조회 -->
  <!-- ==================================== -->
  <select id="getReturnList" parameterType="map" resultType="ReturnVO">
    SELECT 
      r.return_id,
      r.odetail_id,
      r.return_qty,
      r.return_why,
      r.return_price,
      r.return_date,
      r.return_status,
      sod.prod_id,
      sod.prod_name,
      sod.spec,
      sod.unit,
      sod.order_qty,
      sod.prod_unit_price,
      so.order_id,
      so.vendor_id
    FROM "RETURN" r
      JOIN sales_order_detail sod
        ON r.odetail_id = sod.odetail_id
      JOIN sales_order so
        ON sod.order_id = so.order_id
    WHERE 1 = 1

      <!-- 날짜 조건 -->
      <if test="startDate != null and startDate != ''">
        AND r.return_date &gt;= TO_DATE(#{startDate}, 'YYYY-MM-DD')
      </if>
      <if test="endDate != null and endDate != ''">
        AND r.return_date &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD')
      </if>

      <!-- 반품 상태 -->
      <if test="returnStatus != null and returnStatus != ''">
        AND r.return_status = #{returnStatus}
      </if>

      <!-- 제품명 검색 -->
      <if test="prodName != null and prodName != ''">
        AND sod.prod_name LIKE '%' || #{prodName} || '%'
      </if>

      <!-- 반품번호 검색 -->
      <if test="returnNo != null and returnNo != ''">
        AND r.return_id LIKE '%' || #{returnNo} || '%'
      </if>

    ORDER BY r.return_date DESC, r.return_id DESC
  </select>

  <!-- ==================================== -->
  <!-- 3. 반품 상세 조회 -->
  <!-- ==================================== -->
  <select id="getReturnDetail" parameterType="string" resultType="ReturnVO">
    SELECT 
      r.return_id,
      r.odetail_id,
      r.return_qty,
      r.return_why,
      r.return_price,
      r.return_date,
      r.return_status,
      sod.prod_id,
      sod.prod_name,
      sod.spec,
      sod.unit,
      sod.order_qty,
      sod.prod_unit_price
    FROM "RETURN" r
      JOIN sales_order_detail sod
        ON r.odetail_id = sod.odetail_id
    WHERE r.return_id = #{returnId}
  </select>

  <!-- ==================================== -->
  <!-- 4. 반품 상태 업데이트 -->
  <!-- ==================================== -->
  <update id="updateReturnStatus" parameterType="map">
    UPDATE "RETURN"
    SET return_status = #{returnStatus}
    WHERE return_id = #{returnId}
  </update>

  <!-- ==================================== -->
  <!-- 5. 반품 삭제 -->
  <!-- ==================================== -->
  <delete id="deleteReturn" parameterType="string">
    DELETE FROM "RETURN"
    WHERE return_id = #{returnId}
  </delete>

</mapper>
