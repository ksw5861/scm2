<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yedam.scm.mapper.ReturnMapper">

  <!-- ==================================== -->
  <!-- 1. 반품 등록 -->
  <!-- ==================================== -->
  <insert id="insertReturn" parameterType="com.yedam.scm.vo.ReturnVO">
    INSERT INTO return (
      return_id,
      odetail_id,
      return_qty,
      return_why,
      return_price,
      return_date,
      return_status
    ) VALUES (
      next_date_code('RT'),
      #{odetailId},
      #{returnQty},
      #{returnWhy},
      #{returnPrice},
      SYSDATE,
      #{returnStatus}
    )
  </insert>

  <!-- ==================================== -->
  <!-- 2. 반품 목록 조회 -->
  <!-- ==================================== -->
  <select id="getReturnList" parameterType="map" resultType="com.yedam.scm.vo.ReturnVO">
    SELECT 
      r.return_id,
      r.odetail_id,
      r.return_qty,
      r.return_why,
      r.return_price,
      TO_CHAR(r.return_date, 'YYYY-MM-DD') AS return_date,
      r.return_status,
      sod.prod_id,
      sod.prod_name,
      sod.prod_spec,
      sod.prod_unit,
      sod.order_qty,
      sod.prod_price,
      so.order_id,
      so.vendor_id
    FROM return r
      JOIN sales_order_detail sod
        ON r.odetail_id = sod.odetail_id
      JOIN sales_order so
        ON sod.order_id = so.order_id
    WHERE 1 = 1
      <if test="startDate != null and startDate != ''">
        AND r.return_date &gt;= TO_DATE(#{startDate}, 'YYYY-MM-DD')
      </if>
      <if test="endDate != null and endDate != ''">
        AND r.return_date &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD')
      </if>
      <if test="status != null and status != ''">
        AND r.return_status = #{status}
      </if>
    ORDER BY r.return_date DESC
  </select>

  <!-- ==================================== -->
  <!-- 3. 반품 상세 조회 (반품 단건) -->
  <!-- ==================================== -->
  <select id="getReturnDetail" parameterType="string" resultType="com.yedam.scm.vo.ReturnVO">
    SELECT 
      r.return_id,
      r.odetail_id,
      r.return_qty,
      r.return_why,
      r.return_price,
      TO_CHAR(r.return_date, 'YYYY-MM-DD') AS return_date,
      r.return_status,
      sod.prod_id,
      sod.prod_name,
      sod.prod_spec,
      sod.prod_unit,
      sod.order_qty,
      sod.prod_price
    FROM return r
      JOIN sales_order_detail sod
        ON r.odetail_id = sod.odetail_id
    WHERE r.return_id = #{returnId}
  </select>

  <!-- ==================================== -->
  <!-- 4. 반품 상태 업데이트 -->
  <!-- ==================================== -->
  <update id="updateReturnStatus" parameterType="map">
    UPDATE return
    SET return_status = #{returnStatus}
    WHERE return_id = #{returnId}
  </update>

  <!-- ==================================== -->
  <!-- 5. 반품 삭제 (필요 시 사용) -->
  <!-- ==================================== -->
  <delete id="deleteReturn" parameterType="string">
    DELETE FROM return
    WHERE return_id = #{returnId}
  </delete>

</mapper>
