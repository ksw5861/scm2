<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.yedam.scm.order.mapper.SalesMarginMapper">

  <sql id="Cols">
    SALE_PROD_ID, SALE_PROD_NAME, SALE_PROD_PRICE,
    PROD_UNIT_PRICE, SALE_MARGIN, SORT_NO, POS_SHOW_YN,
    CREATE_DT, UPDATE_DT
  </sql>

    <!-- POSì„¤ì • - ê¸°ì¡´ë°ì´í„° ì‚­ì œ -->
    <delete id="deleteAll">
        DELETE FROM SALES_MARGIN
    </delete>

    <!-- POSì„¤ì • - ìƒˆ ë°ì´í„° ì‚½ìž… -->
    <insert id="insert" parameterType="SalesMarginVO">
        INSERT INTO SALES_MARGIN (
            SALE_PROD_ID,
            SALE_PROD_NAME,
            PROD_UNIT_PRICE,
            SALE_MARGIN,
            POS_SHOW_YN,
            SORT_NO,
            SALE_PROD_PRICE
        ) VALUES (
            #{saleProdId},
            #{saleProdName},
            #{prodUnitPrice},
            #{saleMargin},
            #{posShowYn},
            #{sortNo},
            #{saleProdPrice}
        )
    </insert>


  <!-- ëª©ë¡ (POS ìˆœì„œëŒ€ë¡œ) -->
  <select id="selectSalesMarginList" resultType="SalesMarginVO">
    SELECT <include refid="Cols"/>
      FROM SALES_MARGIN
     ORDER BY SORT_NO
  </select>

  <!-- ë‹¨ê±´ ì¡°íšŒ -->
  <select id="selectSalesMarginById" parameterType="string" resultType="SalesMarginVO">
    SELECT <include refid="Cols"/>
      FROM SALES_MARGIN
     WHERE SALE_PROD_ID = #{saleProdId}
  </select>

  

  <!-- ì‚­ì œ -->
  <delete id="deleteSalesMargin" parameterType="string">
    DELETE FROM SALES_MARGIN WHERE SALE_PROD_ID = #{saleProdId}
  </delete>





<!-- âœ… POS ê²°ì œ ë“±ë¡ -->

<!-- íŒë§¤ ë§ˆìŠ¤í„° ë“±ë¡ -->
<insert id="insertSaleMaster" parameterType="SalesMasterVO">
  <selectKey keyProperty="saleId" resultType="string" order="BEFORE">
    SELECT 'SI' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '-' ||
           LPAD(NVL(MAX(SUBSTR(sale_id, 12, 3)), 0) + 1, 3, '0')
    FROM sales_master
    WHERE sale_id LIKE 'SI' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '-%'
  </selectKey>

  INSERT INTO sales_master (sale_id, sale_total_amount, sale_date, sale_pay_type, vendor_id)
  VALUES (#{saleId}, #{saleTotalAmount}, SYSDATE, #{salePayType}, #{vendorId})
</insert>


<!-- íŒë§¤ ìƒì„¸ ë“±ë¡ -->
<insert id="insertSaleDetail" parameterType="SalesDetailVO">

  <!-- ðŸ§© 1. íŒë§¤ ìƒì„¸ ID ìžë™ ìƒì„± -->
  <selectKey keyProperty="sdetailId" resultType="string" order="BEFORE">
    SELECT 'SDI' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '-' ||
           LPAD(NVL(MAX(SUBSTR(sdetail_id, 13, 3)), 0) + 1, 3, '0')
    FROM sales_detail
    WHERE sdetail_id LIKE 'SDI' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '-%'
  </selectKey>

  <!-- ðŸ§¾ 2. ìƒì„¸ ë°ì´í„° INSERT -->
  INSERT INTO SALES_DETAIL (
      SDETAIL_ID,      
      SALE_ID,         
      SALE_PROD_ID,     
      SALE_PROD_NAME,    
      PROD_UNIT_PRICE,     
      SALE_PROD_PRICE,    
      SALE_MARGIN,      
      SALE_QTY,          
      SALE_TOTAL_PRICE  
  )
  SELECT
      #{sdetailId},           
      #{saleId},                 
      P.SALE_PROD_ID,
      P.SALE_PROD_NAME,
      P.PROD_UNIT_PRICE,         
      P.SALE_PROD_PRICE,          
      P.SALE_MARGIN,
      #{saleQty},
      (P.SALE_PROD_PRICE * #{saleQty})
  FROM SALES_MARGIN P
  WHERE P.SALE_PROD_ID = #{saleProdId}

</insert>




<!-- ë§¤ì¶œ ì´ë ¥ ì¡°íšŒ -->
<select id="getSalesHistory" parameterType="string" resultType="SalesMasterVO">
  SELECT
    sale_id       AS saleId,
    sale_total_amount AS saleTotalAmount,
    TO_CHAR(sale_date, 'YYYY-MM-DD HH24:MI') AS saleDate,
    sale_pay_type AS salePayType,
    vendor_id     AS vendorId
  FROM sales_master
  <where>
    <if test="vendorId != null and vendorId != ''">
      vendor_id = #{vendorId}
    </if>
  </where>
  ORDER BY sale_date DESC
</select>

<!-- ë§¤ì¶œ ìš”ì•½ (ì˜¤ëŠ˜ vs ì–´ì œ) -->
<select id="getDailySales" resultType="map">
    SELECT 
        NVL(SUM(sale_total_amount), 0) AS TOTAL_SALES,
        COUNT(*) AS ORDER_COUNT
    FROM sales_master
    WHERE vendor_id = #{vendorId}
      AND TRUNC(sale_date) = TRUNC(SYSDATE - #{dayOffset})
</select>


<!-- ì´ë²ˆ ë‹¬ ë§¤ì¶œ í•©ê³„ ìš”ì•½ -->
<!-- âœ… ì›” ì´ ë§¤ì¶œ -->
  <select id="getMonthlyTotal" resultType="int">
    SELECT NVL(SUM(sale_total_amount), 0)
    FROM sales_master
    WHERE vendor_id = #{vendorId}
      AND TO_CHAR(sale_date, 'YYYY') = #{year}
      AND TO_CHAR(sale_date, 'MM') = LPAD(#{month}, 2, '0')
  </select>

<!-- âœ… ì¼ìžë³„ ë§¤ì¶œ (ì›”ë³„ íƒ­ìš©) -->
<select id="getMonthlyDailySales" resultType="hashmap">
  SELECT
    TO_CHAR(sale_date, 'YYYY-MM-DD') AS sale_date_str,
    NVL(SUM(sale_total_amount), 0) AS amount
  FROM sales_master
  WHERE vendor_id = #{vendorId}
    AND TO_CHAR(sale_date, 'YYYY') = #{year}
    AND TO_CHAR(sale_date, 'MM') = LPAD(#{month}, 2, '0')
  GROUP BY TO_CHAR(sale_date, 'YYYY-MM-DD')
  ORDER BY sale_date_str
</select>


  <!-- âœ… ì˜ì—…ì¼ ìˆ˜ (ë§¤ì¶œì´ ë°œìƒí•œ ë‚ ì§œ ìˆ˜) -->
  <select id="getWorkingDays" resultType="int">
    SELECT COUNT(DISTINCT TO_CHAR(sale_date, 'YYYY-MM-DD'))
    FROM sales_master
    WHERE vendor_id = #{vendorId}
      AND TO_CHAR(sale_date, 'YYYY') = #{year}
      AND TO_CHAR(sale_date, 'MM') = LPAD(#{month}, 2, '0')
  </select>






  <!-- =========================================================
       ê·¸ëž˜í”„ â‘  ë§¤ì¶œ ì¶”ì´ (ì£¼ë¬¸ vs ë§¤ì¶œ)
       - ì¼ë³„: ìµœê·¼ 180ì¼
       - ì›”ë³„: ìµœê·¼ 24ê°œì›”
       LABEL, ORDER_AMT(=sales_order.total_price), SALES_AMT(=sales_master.sale_total_amount)
  ========================================================== -->
  <!-- ì¼ë³„ -->
  <select id="getSalesTrendDaily" resultType="hashmap">
    SELECT
      d.LABEL,
      NVL(s.SALES_AMT, 0) AS SALES_AMT,
      NVL(o.ORDER_AMT, 0) AS ORDER_AMT
    FROM (
      SELECT TO_CHAR(TRUNC(sale_date), 'YYYY-MM-DD') AS LABEL
        FROM sales_master
       WHERE TRUNC(sale_date) <![CDATA[>=]]> TRUNC(SYSDATE - 179)
         AND vendor_id = #{vendorId}
       GROUP BY TRUNC(sale_date)
      UNION
      SELECT TO_CHAR(TRUNC(order_date), 'YYYY-MM-DD') AS LABEL
        FROM sales_order
       WHERE TRUNC(order_date) <![CDATA[>=]]> TRUNC(SYSDATE - 179)
         AND vendor_id = #{vendorId}
       GROUP BY TRUNC(order_date)
    ) d
    LEFT JOIN (
      SELECT TO_CHAR(TRUNC(sale_date), 'YYYY-MM-DD') AS LABEL,
             SUM(sale_total_amount) AS SALES_AMT
        FROM sales_master
       WHERE TRUNC(sale_date) <![CDATA[>=]]> TRUNC(SYSDATE - 179)
         AND vendor_id = #{vendorId}
       GROUP BY TRUNC(sale_date)
    ) s ON s.LABEL = d.LABEL
    LEFT JOIN (
      SELECT TO_CHAR(TRUNC(order_date), 'YYYY-MM-DD') AS LABEL,
             SUM(total_price) AS ORDER_AMT
        FROM sales_order
       WHERE TRUNC(order_date) <![CDATA[>=]]> TRUNC(SYSDATE - 179)
         AND vendor_id = #{vendorId}
       GROUP BY TRUNC(order_date)
    ) o ON o.LABEL = d.LABEL
    ORDER BY d.LABEL
  </select>

  <!-- ì›”ë³„ -->
  <select id="getSalesTrendMonthly" resultType="hashmap">
    SELECT
      d.LABEL,
      NVL(s.SALES_AMT, 0) AS SALES_AMT,
      NVL(o.ORDER_AMT, 0) AS ORDER_AMT
    FROM (
      SELECT TO_CHAR(TRUNC(sale_date, 'MM'), 'YYYY-MM') AS LABEL
        FROM sales_master
       WHERE TRUNC(sale_date, 'MM') <![CDATA[>=]]> ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -23)
         AND vendor_id = #{vendorId}
       GROUP BY TRUNC(sale_date, 'MM')
      UNION
      SELECT TO_CHAR(TRUNC(order_date, 'MM'), 'YYYY-MM') AS LABEL
        FROM sales_order
       WHERE TRUNC(order_date, 'MM') <![CDATA[>=]]> ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -23)
         AND vendor_id = #{vendorId}
       GROUP BY TRUNC(order_date, 'MM')
    ) d
    LEFT JOIN (
      SELECT TO_CHAR(TRUNC(sale_date, 'MM'), 'YYYY-MM') AS LABEL,
             SUM(sale_total_amount) AS SALES_AMT
        FROM sales_master
       WHERE TRUNC(sale_date, 'MM') <![CDATA[>=]]> ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -23)
         AND vendor_id = #{vendorId}
       GROUP BY TRUNC(sale_date, 'MM')
    ) s ON s.LABEL = d.LABEL
    LEFT JOIN (
      SELECT TO_CHAR(TRUNC(order_date, 'MM'), 'YYYY-MM') AS LABEL,
             SUM(total_price) AS ORDER_AMT
        FROM sales_order
       WHERE TRUNC(order_date, 'MM') <![CDATA[>=]]> ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -23)
         AND vendor_id = #{vendorId}
       GROUP BY TRUNC(order_date, 'MM')
    ) o ON o.LABEL = d.LABEL
    ORDER BY d.LABEL
  </select>

  <!-- =========================================================
       ê·¸ëž˜í”„ â‘¡ ìž‘ë…„ vs ì˜¬í•´ ë¹„êµ (range: daily|monthly)
       - daily: ìµœê·¼ 180ì¼ (YYYY-MM-DD ë‹¨ìœ„)
         THIS_YEAR = í•´ë‹¹ì¼ìž ê¸ˆë…„, LAST_YEAR = ë™ì¼ ì¼ìž ì „ë…„
       - monthly: ìµœê·¼ 24ê°œì›” (YYYY-MM)
         THIS_YEAR = í•´ë‹¹ì›” ê¸ˆë…„, LAST_YEAR = ë™ì¼ ì›” ì „ë…„
  ========================================================== -->
  <select id="getSalesCompare" resultType="hashmap">
    <choose>
      <!-- ì¼ë³„ ë¹„êµ -->
      <when test="range == 'daily'">
        SELECT
          d.LABEL,
          NVL(s_this.AMT, 0) AS THIS_YEAR,
          NVL(s_last.AMT, 0) AS LAST_YEAR
        FROM (
          SELECT TO_CHAR(TRUNC(sale_date), 'YYYY-MM-DD') AS LABEL
            FROM sales_master
           WHERE TRUNC(sale_date) <![CDATA[>=]]> TRUNC(SYSDATE - 179)
             AND vendor_id = #{vendorId}
           GROUP BY TRUNC(sale_date)
        ) d
        LEFT JOIN (
          SELECT TO_CHAR(TRUNC(sale_date), 'YYYY-MM-DD') AS LABEL,
                 SUM(sale_total_amount) AS AMT
            FROM sales_master
           WHERE TRUNC(sale_date) <![CDATA[>=]]> TRUNC(SYSDATE - 179)
             AND vendor_id = #{vendorId}
           GROUP BY TRUNC(sale_date)
        ) s_this ON s_this.LABEL = d.LABEL
        LEFT JOIN (
          SELECT TO_CHAR(TRUNC(ADD_MONTHS(sale_date, +12)), 'YYYY-MM-DD') AS LABEL,
                 SUM(sale_total_amount) AS AMT
            FROM sales_master
           WHERE TRUNC(sale_date) <![CDATA[>=]]> ADD_MONTHS(TRUNC(SYSDATE - 179), -12)
             AND TRUNC(sale_date) <![CDATA[<]]>  ADD_MONTHS(TRUNC(SYSDATE + 1), -12)
             AND vendor_id = #{vendorId}
           GROUP BY TRUNC(ADD_MONTHS(sale_date, +12))
        ) s_last ON s_last.LABEL = d.LABEL
        ORDER BY d.LABEL
      </when>

      <!-- ì›”ë³„ ë¹„êµ -->
      <otherwise>
        SELECT
          d.LABEL,
          NVL(s_this.AMT, 0) AS THIS_YEAR,
          NVL(s_last.AMT, 0) AS LAST_YEAR
        FROM (
          SELECT TO_CHAR(TRUNC(sale_date, 'MM'), 'YYYY-MM') AS LABEL
            FROM sales_master
           WHERE TRUNC(sale_date, 'MM') <![CDATA[>=]]> ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -23)
             AND vendor_id = #{vendorId}
           GROUP BY TRUNC(sale_date, 'MM')
        ) d
        LEFT JOIN (
          SELECT TO_CHAR(TRUNC(sale_date, 'MM'), 'YYYY-MM') AS LABEL,
                 SUM(sale_total_amount) AS AMT
            FROM sales_master
           WHERE TRUNC(sale_date, 'MM') <![CDATA[>=]]> ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -23)
             AND vendor_id = #{vendorId}
           GROUP BY TRUNC(sale_date, 'MM')
        ) s_this ON s_this.LABEL = d.LABEL
        LEFT JOIN (
          SELECT TO_CHAR(ADD_MONTHS(TRUNC(sale_date, 'MM'), +12), 'YYYY-MM') AS LABEL,
                 SUM(sale_total_amount) AS AMT
            FROM sales_master
           WHERE TRUNC(sale_date, 'MM') <![CDATA[>=]]> ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -35)
             AND TRUNC(sale_date, 'MM') <![CDATA[<]]>  ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -11)
             AND vendor_id = #{vendorId}
           GROUP BY ADD_MONTHS(TRUNC(sale_date, 'MM'), +12)
        ) s_last ON s_last.LABEL = d.LABEL
        ORDER BY d.LABEL
      </otherwise>
    </choose>
  </select>

  <!-- =========================================================
       ê·¸ëž˜í”„ â‘¢ ì›ë‘ íŒë§¤ ëž­í‚¹ (ìµœê·¼ 3ê°œì›”, TOP5)
  ========================================================== -->
  <select id="getCoffeeRank" parameterType="map" resultType="hashmap">
  <choose>
    <!-- ì¼ë³„: ìµœê·¼ 30ì¼ -->
    <when test="range == 'daily'">
      SELECT * FROM (
        SELECT sd.sale_prod_name AS LABEL,
               ROUND( SUM(sd.sale_total_price) /
                      NULLIF( (SELECT SUM(sd2.sale_total_price)
                                 FROM sales_detail sd2
                                 JOIN sales_master sm2 ON sd2.sale_id = sm2.sale_id
                                WHERE sm2.vendor_id = #{vendorId}
                                  AND TRUNC(sm2.sale_date) <![CDATA[>=]]> TRUNC(SYSDATE - 30)
                              ), 0) * 100, 1) AS RATE
          FROM sales_detail sd
          JOIN sales_master sm ON sd.sale_id = sm.sale_id
         WHERE sm.vendor_id = #{vendorId}
           AND TRUNC(sm.sale_date) <![CDATA[>=]]> TRUNC(SYSDATE - 30)
         GROUP BY sd.sale_prod_name
         ORDER BY RATE DESC
      ) WHERE ROWNUM <![CDATA[<=]]> 5
    </when>

    <!-- ì›”ë³„: ìµœê·¼ 3ê°œì›” -->
<otherwise>
  SELECT * FROM (
    SELECT sd.sale_prod_name AS LABEL,
           ROUND(
             SUM(sd.sale_total_price) /
             NULLIF(
               (SELECT SUM(sd2.sale_total_price)
                  FROM sales_detail sd2
                  JOIN sales_master sm2 ON sd2.sale_id = sm2.sale_id
                 WHERE sm2.vendor_id = #{vendorId}
                   AND sm2.sale_date <![CDATA[>=]]> ADD_MONTHS(TRUNC(SYSDATE), -3)
               ), 0
             ) * 100, 1
           ) AS RATE
      FROM sales_detail sd
      JOIN sales_master sm ON sd.sale_id = sm.sale_id
     WHERE sm.vendor_id = #{vendorId}
       AND sm.sale_date <![CDATA[>=]]> ADD_MONTHS(TRUNC(SYSDATE), -3)
     GROUP BY sd.sale_prod_name
     ORDER BY RATE DESC
  ) WHERE ROWNUM <![CDATA[<=]]> 5
</otherwise>
  </choose>
</select>


  <!-- =========================================================
       ê·¸ëž˜í”„ â‘£ ê²°ì œìˆ˜ë‹¨ë³„ ë§¤ì¶œ (CARD / CASH)
       - ì¼ë³„: ìµœê·¼ 180ì¼ ì¼ë‹¨ìœ„
       - ì›”ë³„: ìµœê·¼ 24ê°œì›” ì›”ë‹¨ìœ„
  ========================================================== -->
  <select id="selectPayMethod" parameterType="map" resultType="map">
    SELECT
      <choose>
        <when test="range == 'daily'">
          TO_CHAR(TRUNC(s.sale_date), 'YYYY-MM-DD') AS LABEL
        </when>
        <otherwise>
          TO_CHAR(TRUNC(s.sale_date, 'MM'), 'YYYY-MM') AS LABEL
        </otherwise>
      </choose>,
      SUM(CASE WHEN s.sale_pay_type = 'CARD' THEN s.sale_total_amount ELSE 0 END) AS CARD,
      SUM(CASE WHEN s.sale_pay_type = 'CASH' THEN s.sale_total_amount ELSE 0 END) AS CASH
      FROM SALES_MASTER s
     WHERE s.vendor_id = #{vendorId}
       <choose>
         <when test="range == 'daily'">
           AND TRUNC(s.sale_date) <![CDATA[>=]]> TRUNC(SYSDATE - 179)
         </when>
         <otherwise>
           AND TRUNC(s.sale_date, 'MM') <![CDATA[>=]]> ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -23)
         </otherwise>
       </choose>
     GROUP BY
      <choose>
        <when test="range == 'daily'">
          TO_CHAR(TRUNC(s.sale_date), 'YYYY-MM-DD')
        </when>
        <otherwise>
          TO_CHAR(TRUNC(s.sale_date, 'MM'), 'YYYY-MM')
        </otherwise>
      </choose>
     ORDER BY LABEL
  </select>

  <!-- =========================================================
       ë§¤ì¶œ ì„±ìž¥ë¥  (KPIìš©)
  ========================================================== -->
  <select id="selectSalesGrowth" resultType="hashmap">
    SELECT
      NVL(SUM(CASE WHEN TRUNC(SALE_DATE) = TRUNC(SYSDATE) THEN SALE_TOTAL_AMOUNT END), 0) AS TODAY,
      NVL(SUM(CASE WHEN TRUNC(SALE_DATE) = TRUNC(SYSDATE - 1) THEN SALE_TOTAL_AMOUNT END), 0) AS YESTERDAY,
      NVL(SUM(CASE WHEN TO_CHAR(SALE_DATE, 'YYYYMM') = TO_CHAR(SYSDATE, 'YYYYMM') THEN SALE_TOTAL_AMOUNT END), 0) AS CURR_MONTH,
      NVL(SUM(CASE WHEN TO_CHAR(SALE_DATE, 'YYYYMM') = TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM') THEN SALE_TOTAL_AMOUNT END), 0) AS PREV_MONTH,
      NVL(SUM(CASE WHEN TO_CHAR(SALE_DATE, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY') THEN SALE_TOTAL_AMOUNT END), 0) AS THIS_YEAR,
      NVL(SUM(CASE WHEN TO_CHAR(SALE_DATE, 'YYYY') = TO_CHAR(ADD_MONTHS(SYSDATE, -12), 'YYYY') THEN SALE_TOTAL_AMOUNT END), 0) AS LAST_YEAR
      FROM SALES_MASTER
     WHERE VENDOR_ID = #{vendorId}
  </select>


<!-- ëŒ€ì‹œë³´ë“œì— ë¯¸ìˆ˜ê¸ˆ í•©ê³„  -->
<select id="selectNextDueAmount" parameterType="string" resultType="com.yedam.scm.vo.SalesOrderVO">
    SELECT
      NVL(SUM(total_price), 0) AS next_due_amount,
      TO_CHAR(
        CASE
          WHEN <![CDATA[ TO_NUMBER(TO_CHAR(SYSDATE, 'DD')) <= 15 ]]> 
            THEN TRUNC(SYSDATE, 'MM') + 14
          ELSE
            ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1) + 14
        END,
        'YYYY-MM-DD'
      ) AS next_due_date
    FROM SALES_ORDER
    WHERE VENDOR_ID  = #{vendorId}
      AND STATUS     IN ('ì¶œê³ ì™„ë£Œ', 'ë°°ì†¡ì™„ë£Œ')
      AND PAY_STATUS = 'ëŒ€ê¸°'
      AND TRUNC(SEND_DATE) BETWEEN
        CASE
          WHEN <![CDATA[ TO_NUMBER(TO_CHAR(SYSDATE, 'DD')) <= 15 ]]> 
            THEN TRUNC(ADD_MONTHS(SYSDATE, -1), 'MM')
          ELSE
            TRUNC(SYSDATE, 'MM')
        END
        AND
        CASE
          WHEN <![CDATA[ TO_NUMBER(TO_CHAR(SYSDATE, 'DD')) <= 15 ]]> 
            THEN LAST_DAY(ADD_MONTHS(SYSDATE, -1))
          ELSE
            TRUNC(SYSDATE)
        END
  </select>

<!-- ëŒ€ì‹œë³´ë“œì— ì—¬ì‹ í•œë„ ìž”ì•¡-->
  <select id="selectSalesFinanceSummary" parameterType="string" resultType="SalesOrderVO">
    SELECT
      NVL(SUM(s.total_price), 0) AS nextDueAmount,        
      TO_CHAR(
        CASE
          WHEN <![CDATA[ TO_NUMBER(TO_CHAR(SYSDATE, 'DD')) <= 15 ]]>
            THEN TRUNC(SYSDATE, 'MM') + 14               
          ELSE
            ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1) + 14     
        END,
        'YYYY-MM-DD'
      ) AS nextDueDate,                                  
      MAX(v.credit_limit) AS creditLimit,               
      NVL(SUM(s.return_price), 0) AS totalReturn,        
      (MAX(v.credit_limit) - (NVL(SUM(s.total_price), 0) - NVL(SUM(s.return_price), 0))) AS remainCredit
    FROM SALES_ORDER s
    JOIN VENDOR v ON s.vendor_id = v.vendor_id
    WHERE s.vendor_id = #{vendorId}
      AND s.status IN ('ì²˜ë¦¬ì™„ë£Œ', 'ì¶œê³ ì™„ë£Œ', 'ë°°ì†¡ì™„ë£Œ')
      AND s.pay_status = 'ëŒ€ê¸°'
  </select>


</mapper>
