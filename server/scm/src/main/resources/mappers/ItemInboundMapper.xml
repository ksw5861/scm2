<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yedam.scm.product.mapper.InboundMapper">

  <!-- ===================== LOT 목록 조회 ===================== -->
  <select id="selectInboundLots" resultType="com.yedam.scm.vo.ProductLotVO">
    SELECT pl.prod_no,
           pl.prod_id,
           pl.pro_qty,
           pl.mat_status,
           pl.pro_date + p.exp end_date,
           pl.pro_date,
           p.prod_name,
           p.spec,
           p.unit
      FROM product_plan_detail pl
      JOIN product p ON p.prod_id = pl.prod_id
     WHERE mat_status = '입고대기'
       <if test="prodId != null and prodId != ''">
         AND pl.prod_id = #{prodId}
       </if>
       <if test="prodName != null and prodName != ''">
         AND p.prod_name LIKE '%' || #{prodName} || '%'
       </if>
       <if test="endDate != null">
         AND TRUNC(pl.pro_date) = TRUNC(#{endDate})
       </if>
       <if test="prodNo != null and prodNo != ''">
         AND pl.prod_no = #{prodNo}
       </if>
     ORDER BY pl.prod_No DESC
  </select>

  <update id="updateInbound" parameterType="com.yedam.scm.vo.ProductLotVO">
    UPDATE Product_LOT
       SET total_qty     = #{totalQty},
           remain_qty    = NVL(remain_qty,0) + #{totalQty},
           transfer_date = NVL(#{transferDate}, SYSDATE),
           status        = 'Y'
     WHERE prd_lot = #{prdLot}
  </update>

  <!-- 프로시저 호출 -->
  <select id="callInsertInbound" parameterType="map" statementType="CALLABLE">
    { call INSERT_INBOUND(
        #{prodNo,     mode=IN, jdbcType=VARCHAR},
        #{whId,       mode=IN, jdbcType=VARCHAR},
        #{totalQty,   mode=IN, jdbcType=NUMERIC},
        #{employeeId, mode=IN, jdbcType=VARCHAR},
        #{rowCount,   mode=OUT, jdbcType=NUMERIC, javaType=java.lang.Integer}
      ) }
  </select>


  <!-- ===================== 모달 ===================== -->
  <select id="selectInboundProductListByCondition" resultType="ProductVO">
    SELECT *
      FROM (
        SELECT p.prod_id,
               p.prod_name,
               ROW_NUMBER() OVER (ORDER BY p.prod_id DESC) AS rn
          FROM product p
         WHERE 1=1
           <if test="condition != null and condition != ''">
             AND (p.prod_id LIKE '%' || #{condition} || '%'
                  OR p.prod_name LIKE '%' || #{condition} || '%')
           </if>
      )
     WHERE rn BETWEEN #{paging.startRow} AND #{paging.endRow}
  </select>

  <select id="selectInboundProductCountByCondition" resultType="long">
    SELECT COUNT(*)
      FROM product p
     WHERE 1=1
       <if test="condition != null and condition != ''">
         AND (p.prod_id LIKE '%' || #{condition} || '%'
              OR p.prod_name LIKE '%' || #{condition} || '%')
       </if>
  </select>

  <!-- 창고 모달 -->
  <select id="selectWarehouseListByCondition" resultType="WareHouseVO">
    SELECT *
      FROM (
        SELECT w.wh_id   AS whId,
               w.wh_name AS whName,
               ROW_NUMBER() OVER (ORDER BY w.wh_id DESC) AS rn
          FROM warehouse w
         WHERE 1=1
           <if test="condition != null and condition != ''">
             AND (w.wh_id LIKE '%' || #{condition} || '%'
                  OR w.wh_name LIKE '%' || #{condition} || '%')
           </if>
      )
     WHERE rn BETWEEN #{paging.startRow} AND #{paging.endRow}
  </select>

  <select id="selectWarehouseCountByCondition" resultType="long">
    SELECT COUNT(*)
      FROM warehouse w
     WHERE 1=1
       <if test="condition != null and condition != ''">
         AND (w.wh_id LIKE '%' || #{condition} || '%'
              OR w.wh_name LIKE '%' || #{condition} || '%')
       </if>
  </select>


  <!-- ===================== 주문승인 ===================== -->
  <select id="selectApprovalOrders" resultType="com.yedam.scm.vo.SalesOrderVO">
    SELECT so.order_id,
           so.order_date,
           v.company_name,
           so.status prod_status
      FROM sales_order so
      LEFT JOIN vendor v ON so.vendor_id = v.vendor_id
     WHERE so.status in ('대기', '처리중')
     ORDER BY so.order_date DESC
  </select>

  <resultMap id="SalesOrderDetailMap" type="com.yedam.scm.vo.SalesOrderDetailVO">
    <id     column="odetail_id"      property="odetailId"/>
    <result column="order_id"        property="orderId"/>
    <result column="prod_id"         property="prodId"/>
    <result column="prod_name"       property="prodName"/>
    <result column="spec"            property="spec"/>
    <result column="unit"            property="unit"/>
    <result column="order_qty"       property="orderQty"/>
    <result column="prod_unit_price" property="prodUnitPrice"/>
    <result column="prod_status"     property="prodStatus"/>
  </resultMap>

  <select id="selectApprovalDetails" resultMap="SalesOrderDetailMap">
    SELECT sod.odetail_id,
           sod.order_id,
           sod.prod_id,
           p.prod_name,
           p.spec,
           p.unit,
           sod.order_qty,
           sod.prod_unit_price,
           sod.prod_status
      FROM sales_order_detail sod
      LEFT JOIN product p ON p.prod_id = sod.prod_id
     WHERE sod.order_id = #{orderId}
     ORDER BY sod.odetail_id
  </select>

  <update id="approveDetails">
    UPDATE sales_order_detail
       SET prod_status = '승인'
     WHERE odetail_id IN
     <foreach collection="odetailIds" item="id" open="(" separator="," close=")">
       #{id}
     </foreach>
  </update>

  <update id="rejectDetails">
    UPDATE sales_order_detail
       SET prod_status = '반려'
     WHERE odetail_id IN
     <foreach collection="odetailIds" item="id" open="(" separator="," close=")">
       #{id}
     </foreach>
  </update>


  <!-- ===================== 반품승인 ===================== -->
  <select id="selectReturnList" resultType="com.yedam.scm.vo.ReturnVO">
    SELECT r.return_id,
           r.return_date,
           v.company_name,
           r.return_status
      FROM return r
      LEFT JOIN vendor v ON r.vendor_id = v.vendor_id
     WHERE r.return_status IN ('대기','처리중')
     ORDER BY r.return_date DESC
  </select>

  <select id="selectReturnDetails" resultType="ReturnDetailVO">
    SELECT d.rdetail_id       AS rdetailId,
           d.return_id        AS returnId,
           d.prod_id          AS prodId,
           p.prod_name        AS prodName,
           d.return_qty       AS returnQty,
           d.prod_unit_price  AS prodUnitPrice,
           (d.return_qty * d.prod_unit_price) AS amt,
           d.return_why       AS returnWhy,
           d.rdetail_status   AS rdetailStatus,
           v.company_name     AS companyName
      FROM return_detail d
      JOIN product p ON d.prod_id = p.prod_id
      LEFT JOIN return r ON d.return_id = r.return_id
      LEFT JOIN vendor v ON r.vendor_id = v.vendor_id
     WHERE d.return_id = #{returnId}
  </select>

  <update id="approveReturnDetails">
    UPDATE return_detail
       SET rdetail_status = '승인'
     WHERE rdetail_id IN
     <foreach collection="ids" item="id" open="(" separator="," close=")">
       #{id}
     </foreach>
  </update>

  <update id="rejectReturnDetails">
    UPDATE return_detail
       SET rdetail_status = '반려',
           return_why = #{reason}
     WHERE rdetail_id IN
     <foreach collection="ids" item="id" open="(" separator="," close=")">
       #{id}
     </foreach>
  </update>


  <!-- ===================== 출하지시 ===================== -->

  <!-- 출하지시 대상 주문 목록 (SalesOrderVO 기준) -->
  <select id="selectShippingOrders" resultType="com.yedam.scm.vo.SalesOrderVO">
    SELECT so.order_id,
           so.order_date,
           v.company_name,
           so.status
      FROM sales_order so
      LEFT JOIN vendor v ON so.vendor_id = v.vendor_id
     WHERE so.status = '처리완료'
     ORDER BY so.order_date DESC
  </select>

<!-- 다건 주문 출하지시 등록 -->
<insert id="insertShipOrders" parameterType="com.yedam.scm.vo.ShipOrderVO">
  <selectKey keyProperty="shipId" resultType="string" order="BEFORE">
    SELECT next_date_code('OB') FROM dual
  </selectKey>
  
  INSERT INTO ship_order (
    ship_id,
    order_id,
    ship_date,
    ship_status
  ) VALUES (
    #{shipId},
    #{orderId},
    SYSDATE,
    '대기'
  )
</insert>






<!-- ===================== 거래처원장 목록 ===================== -->
<select id="selectAccountLedgerList" parameterType="AccountLedgerSearchDTO" resultType="SalesOrderVO">
  SELECT
      v.vendor_id AS vendorId,
      v.company_name AS companyName,
      NVL(prev.total_price, 0) AS prevTotalPrice,
      NVL(s.total_price, 0) AS totalPrice,
      NVL(r.return_price, 0) AS returnPrice,
      NVL(p.pay_amount, 0) AS totalPayment,
      NVL(s.total_price, 0) - NVL(r.return_price, 0) - NVL(p.pay_amount, 0) AS totalAr,
      MAX_SO.last_order_date AS lastOrderDate
  FROM vendor v
  LEFT JOIN (
      SELECT 
          vendor_id,
          SUM(total_price) AS total_price
      FROM sales_order
      WHERE pay_status = '대기'
        AND status IN ('출고완료', '배송완료')
        <if test="startDate != null">
          AND order_date &lt; #{startDate}
        </if>
      GROUP BY vendor_id
  ) prev ON v.vendor_id = prev.vendor_id

  LEFT JOIN (
      SELECT
          vendor_id,
          SUM(total_price) AS total_price
      FROM sales_order
      WHERE status IN ('출고완료', '배송완료')
        <if test="startDate != null and endDate != null">
          AND order_date BETWEEN #{startDate} AND #{endDate}
        </if>
        <if test="startDate != null and endDate == null">
          AND order_date &gt;= #{startDate}
        </if>
        <if test="startDate == null and endDate != null">
          AND order_date &lt;= #{endDate}
        </if>
      GROUP BY vendor_id
  ) s ON v.vendor_id = s.vendor_id

  LEFT JOIN (
      SELECT
          r.vendor_id,
          SUM(rd.return_qty * rd.prod_unit_price) AS return_price
      FROM return r
      JOIN return_detail rd ON r.return_id = rd.return_id
      WHERE rd.rdetail_status = '승인'
        <if test="startDate != null and endDate != null">
          AND r.return_date BETWEEN #{startDate} AND #{endDate}
        </if>
        <if test="startDate != null and endDate == null">
          AND r.return_date &gt;= #{startDate}
        </if>
        <if test="startDate == null and endDate != null">
          AND r.return_date &lt;= #{endDate}
        </if>
      GROUP BY r.vendor_id
  ) r ON v.vendor_id = r.vendor_id

  LEFT JOIN (
      SELECT
          vendor_id,
          SUM(pay_amount) AS pay_amount
      FROM payment
        <trim prefix="WHERE" prefixOverrides="AND |OR ">
          <if test="startDate != null and endDate != null">
            pay_date BETWEEN #{startDate} AND #{endDate}
          </if>
          <if test="startDate != null and endDate == null">
            pay_date &gt;= #{startDate}
          </if>
          <if test="startDate == null and endDate != null">
            pay_date &lt;= #{endDate}
          </if>
        </trim>
      GROUP BY vendor_id
  ) p ON v.vendor_id = p.vendor_id

  LEFT JOIN (
      SELECT
          vendor_id,
          MAX(order_date) AS last_order_date
      FROM sales_order
      GROUP BY vendor_id
  ) MAX_SO ON v.vendor_id = MAX_SO.vendor_id

  <where>
      <if test="vendorId != null and vendorId != ''">
          v.vendor_id = #{vendorId}
      </if>
  </where>
</select>


  <!-- ===================== 거래처원장 상단 요약 ===================== -->
<select id="selectAccountLedgerSummary" parameterType="map" resultType="SalesOrderVO">
  SELECT
      NVL(s.total_price, 0) AS totalPrice,
      NVL(r.return_price, 0) AS returnPrice,
      NVL(p.pay_amount, 0) AS totalPayment,
      NVL(s.total_price, 0) - NVL(r.return_price, 0) - NVL(p.pay_amount, 0) AS totalAr,
      MAX_SO.last_order_date AS lastOrderDate
  FROM
      (SELECT SUM(total_price) AS total_price FROM sales_order WHERE status in ('출고완료', '배송완료')) s,
      (SELECT SUM(rd.return_qty * rd.prod_unit_price) AS return_price
      FROM return r
      JOIN return_detail rd ON r.return_id = rd.return_id
      WHERE rd.rdetail_status = '승인') r,
      (SELECT SUM(pay_amount) AS pay_amount FROM payment) p,
      (SELECT MAX(order_date) AS last_order_date FROM sales_order) MAX_SO
</select>









</mapper>
