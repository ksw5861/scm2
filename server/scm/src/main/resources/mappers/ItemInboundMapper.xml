<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yedam.scm.product.mapper.InboundMapper">

  
  <!-- ===== resultMap: DB 컬럼명 → VO 필드명 매핑 (AS 없이) ===== -->
  

   <!-- LOT 목록 조회 -->
  <select id="selectInboundLots"
          resultType="com.yedam.scm.vo.ProductLotVO">
    SELECT
      pl.prd_lot,
      pl.prod_id,
      p.prod_name,
      pl.total_qty,
      pl.remain_qty,
      pl.status,
      pp.end_date
    FROM Product_LOT pl
      JOIN product p
        ON p.prod_id = pl.prod_id
      LEFT JOIN product_plan_detail pd
        ON pd.prod_id = pl.prod_id
      LEFT JOIN product_plan pp
        ON pp.pl_id = pd.pl_id
    <where>
      <if test="prodId != null and prodId != ''">
        AND pl.prod_id = #{prodId}
      </if>
      <if test="prodName != null and prodName != ''">
        AND p.prod_name LIKE '%' || #{prodName} || '%'
      </if>
      <if test="endDate != null">
        AND TRUNC(pp.end_date) = TRUNC(#{endDate})
      </if>
      <if test="prdLot != null and prdLot != ''">
        AND pl.prd_lot = #{prdLot}
      </if>
    </where>
    ORDER BY pl.prd_lot DESC
  </select>

  <!-- 입고 등록 (Product_LOT 업데이트) -->
  <update id="updateInbound" parameterType="com.yedam.scm.vo.ProductLotVO">
    UPDATE Product_LOT
    SET
      total_qty     = #{totalQty},
      remain_qty    = NVL(remain_qty,0) + #{totalQty},
      transfer_date = NVL(#{transferDate}, SYSDATE),
      <!-- wh_id         = #{whId}, -->
      status        = 'Y'
    WHERE prd_lot = #{prdLot}
  </update>

  <!-- 입고 삭제 -->
  <delete id="deleteInbound" parameterType="string">
    DELETE FROM Product_LOT WHERE prd_lot = #{prdLot}
  </delete>

</mapper>
