<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yedam.scm.purchaseMat.mapper.PurchaseMatMapper">
<!--중첩VO 정의-->
<!--생산계획상세 + 제품마스터테이블-->
<resultMap id="PrdPlanDetailMap" type="PrdPlanDetailVO">
  <id property="plDetId" column="pl_det_id"/>
  <result property="prodId" column="prod_id"/>
  <result property="proQty" column="pro_qty"/>
  <result property="proDate" column="pro_date"/>
  <result property="plId" column="pl_id"/>
  <result property="matStatus" column="mat_status"/>
  <result property="prodNo" column="prod_no"/>

  <association property="productVO" resultMap="com.yedam.scm.common.CommonMapper.ProductMap"/>
</resultMap>

<!--mrp상세-->
<resultMap id="MrpDetailMap" type="MrpDetailVO">
    <id property="mrpDetId" column="MRP_DET_ID"/>
    <result property="plId" column="PL_ID"/>
    <result property="matId" column="MAT_ID"/>
    <result property="needsWeight" column="NEEDS_WEIGHT"/>
    <result property="currentStock" column="CURRENT_STOCK"/>
    <result property="onOrderQty" column="ON_ORDER_QTY"/>
    <result property="safeStock" column="SAFE_STOCK"/>
    <result property="shortageQty" column="SHORTAGE_QTY"/>
    <result property="unit" column="UNIT"/>
    <result property="leadTime" column="LEAD_TIME"/>
    <result property="calDate" column="CAL_DATE"/>
    <result property="empName" column="EMP_NAME"/>
    <result property="status" column="STATUS"/>

  <association property="materialVO" resultMap="com.yedam.scm.common.CommonMapper.MaterialMap"/>
</resultMap>

<!--자재별거래처-->
<resultMap id="MatVendorMap" type="MatVendorVO">
    <result property="matVendorId" column="MAT_VENDOR_ID"/>
    <result property="contractPrice" column="CONTRACT_PRICE"/>
    <result property="matId" column="MAT_ID"/>
    <result property="vendorId" column="VENDOR_ID"/>
    <result property="createdBy" column="CREATED_BY"/>
    <result property="createdAt" column="CREATED_AT"/>
    <result property="status" column="STATUS"/>

    <association property="materialVO" resultMap="com.yedam.scm.common.CommonMapper.MaterialMap"/>
    <association property="vendorVO" resultMap="com.yedam.scm.common.CommonMapper.VendorMap"/>
</resultMap>

<!--자재주문-->
<resultMap id="PurchaseMatMap" type="PurchaseMatVO">
    <id property="purId" column="PUR_ID" />
    <result property="matId" column="MAT_ID" />
    <result property="reqQty" column="REQ_QTY" />
    <result property="outTotalQty" column="OUT_TOTAL_QTY" />
    <result property="purMatStatus" column="PUR_MAT_STATUS" />
    <result property="resonComm" column="RESON_COMM" />
    <result property="rejDate" column="REJ_DATE" />
    <result property="mrpDetId" column="MRP_DET_ID" />
    <result property="vendorId" column="VENDOR_ID" />
    <result property="empName" column="EMP_NAME" />
    <result property="regDate" column="REG_DATE" />
    <result property="purNo" column="PUR_NO" />
    <result property="total" column="TOTAL" />
    <result property="dueDate" column="DUE_DATE" />
    <result property="expectDate" column="EXPECT_DATE" />
    <result property="outQty" column="OUT_QTY" />
    <result property="shipOrderNo" column="SHIP_ORDER_NO" />
    <result property="toWarehouse" column="TO_WAREHOUSE" />

    <association property="materialVO" resultMap="com.yedam.scm.common.CommonMapper.MaterialMap"/>
    <association property="purStatusLogVO" resultMap="com.yedam.scm.common.CommonMapper.PurStatusLogMap"/>
    <association property="vendorVO" resultMap="com.yedam.scm.common.CommonMapper.VendorMap"/>
</resultMap>

<!-- ##생산계획 등록 -->
<!-- 1. 생산계획 마스터 등록 -->
<insert id="insertProductionPlan" parameterType="ProductionPlanVO">
    <!-- 시퀀스 먼저 뽑아서 VO.planId 에 세팅 -->
    <selectKey keyProperty="plId" resultType="long" order="BEFORE">
        SELECT seq_product_plan.NEXTVAL FROM dual
    </selectKey>
    INSERT INTO product_plan (
        pl_id,
        start_date,
        end_date,
        plan_no,
        emp_name,
        plan_type,
        memo
    )
    VALUES (
        #{plId},               <!-- selectKey로 얻은 값 -->
        #{startDate},
        #{endDate},
        NEXT_DATE_CODE('PP'),    <!-- 커스텀 코드 함수 (있다면) -->
        #{empName},
        #{planType},
        #{memo}
    )
</insert>

<!-- 2. 생산계획 디테일 등록 -->
<insert id="insertProductionPlanDetail" parameterType="PrdPlanDetailVO">
    <selectKey keyProperty="plDetId" resultType="long" order="BEFORE">
        SELECT seq_product_plan_detail.NEXTVAL FROM dual
    </selectKey>
    INSERT INTO product_plan_detail (
        pl_det_id,
        prod_id,
        pro_qty, 
        pro_date,  
        pl_id,  
        prod_no 
    )
    VALUES (
        #{plDetId},
        #{prodId},         
        #{proQty},
        #{proDate},
        #{plId},
            NEXT_DATE_CODE('PNO') <!--제품LOT번호-->
    )
</insert>

<!--3. 생산시 내부 자재요청insert프로시저-->
<select id="callInsertReqMatProc" statementType="CALLABLE">
{ call PROC_INSERT_REQ_MAT( #{plDetId, mode=IN, jdbcType=NUMERIC} ) }
</select>

<!--#자재요청-->
<!--생산계획마스터-->
<select id="getPlanMasterList" resultType="ProductionPlanVO">
SELECT pl_id, 
        start_date,
        end_date,
        plan_no,
        plan_type,
        memo,
        emp_name,
        re_date
FROM product_plan
WHERE mrp_status = 'pp0'
</select>

<!-- 생산계획 상세조회 -->
<select id="selectPlanDetailList" parameterType="long" resultMap="PrdPlanDetailMap">
    SELECT 
        pd.pl_det_id,
        pd.prod_id,
        p.prod_name,
        pd.pro_qty,
        pd.pro_date,
        p.unit,
        p.spec,
        p.status,
        p.bom_version
    FROM product_plan_detail pd
    JOIN product p
        ON pd.prod_id = p.prod_id
    WHERE pd.pl_id = #{plId}
    ORDER BY pd.pro_date
</select>

<!--mrp산출-->
<select id="callCalcMrpProc" statementType="CALLABLE">
    { call PROC_CALC_MRP(
        #{plId, mode=IN, jdbcType=NUMERIC},
        #{empName, mode=IN, jdbcType=VARCHAR}
    )}
</select>

    <!--mrp목록-->
    <select id="getMrpList" resultMap="MrpDetailMap">
SELECT md.mrp_det_id,
       md.mat_id,
       m.mat_name,
       md.needs_weight,
       md.safe_stock,
       md.shortage_qty,
       md.unit,
       md.lead_time
FROM mrp_detail md
JOIN material m ON md.mat_id = m.mat_id
WHERE md.status = 're0'
  AND md.shortage_qty > 0
ORDER BY md.mrp_det_id DESC

    </select>

<!--자재주문프로시저-->
    <select id="callReqestMatProc" parameterType="PurchaseMatVO" statementType="CALLABLE">
    { call PROC_REQ_MATERIAL(
        #{matId,    mode=IN, jdbcType=VARCHAR},  
        #{reqQty,   mode=IN, jdbcType=NUMERIC},  
        #{vendorId, mode=IN, jdbcType=VARCHAR}, 
        #{total,    mode=IN, jdbcType=NUMERIC},  
        #{dueDate,  mode=IN, jdbcType=DATE},     
        #{mrpDetId, mode=IN, jdbcType=NUMERIC}, 
        #{toWarehouse,  mode=IN, jdbcType=VARCHAR}, 
        #{empName,  mode=IN, jdbcType=VARCHAR}   
    )}
</select>

<!--자재주문목록-->
<select id = "getPurchaseList" resultMap="PurchaseMatMap">
SELECT * FROM (
 SELECT a.*, ROWNUM rnum
  FROM (
    SELECT pm.pur_id,
           pm.reg_date,
           pm.pur_no,
           pm.req_qty,
           m.mat_name,
           v.company_name,
           pm.pur_mat_status,
           pm.emp_name,
           m.stock_unit
    FROM purchase_mat pm
    JOIN material m
    ON pm.mat_id = m.mat_id
    JOIN vendor v
    ON pm.vendor_id = v.vendor_id
    ORDER BY pm.reg_date DESC
     ) a
    WHERE ROWNUM &lt;= #{endRow}
)
WHERE rnum &gt;= #{startRow}
    </select>
    
<!--자재주문마스터 수량 for pagenation-->
<select id="getPurchaseMasterCount" resultType="long">
SELECT count (pur_id)
FROM purchase_mat
</select>

<!--자재주문상세이력-->
<select id ="getPurchaseStatus" parameterType="long" resultType = "PurStatusLogVO">
SELECT psl.PUR_STATUS_ID,
        psl.re_date,
        psl.log_name,
        psl.log_pur_mat_status,
        NVL(psl.log_sup_out_qty,0) as log_sup_out_qty,
        psl.log_expect_date,
        psl.log_reson_comm
FROM purchase_status_log psl
WHERE log_pur_id = #{purId}
ORDER BY re_date DESC
</select>
    
<!--드롭다운/모달용===============================================================================-->
<!--제품목록-->
<select id="getProductList" resultType="ProductVO">
    SELECT prod_id,
           prod_name,
           unit
    FROM product
    WHERE status = 'Y'
</select>


<!--자재별 계약거래처-->
  <select id="getMatVendorList" parameterType="string" resultMap="MatVendorMap">
    SELECT mv.vendor_id,
           v.company_name,
           mv.contract_price
    FROM material_vendor mv
    JOIN vendor v
    ON mv.vendor_id = v.vendor_id
    Where mv.mat_id = #{matId}
 </select>


<!--창고목록-->
<select id ="getWarehouseList" resultType="WareHouseVO">
SELECT wh_id,
       wh_name,
       wh_address,
       wh_owner,
       owner_tel
FROM warehouse
WHERE status = '정상'
</select>

<!-- 자재공통코드 상태값 -->
<select id="selectCodeList" parameterType="string" resultType="MatStatusVO">
SELECT GROUP_ID,
       CODE_ID,
       CODE_NAME
FROM MAT_STATUS_DETAIL
WHERE GROUP_ID = #{groupId}
ORDER BY CODE_ID
</select>



</mapper>
