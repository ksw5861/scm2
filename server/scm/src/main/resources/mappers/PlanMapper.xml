<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yedam.scm.outboundMat.mapper.PlanMapper">

  <!-- 좌측 목록: PRODUCT_PLAN_DETAIL -->
  <select id="selectPlanDetails"
          parameterType="map"
          resultType="com.yedam.scm.vo.PrdPlanDetailVO">
    SELECT
      PL_DET_ID  AS plDetId,
      PROD_ID    AS prodId,
      PRO_QTY    AS proQty,
      PRO_DATE   AS proDate,
      PL_ID      AS plId,
      MAT_STATUS AS matStatus,
      PROD_NO    AS prodNo
    FROM PRODUCT_PLAN_DETAIL
    <where>
      <if test="plId != null">
        AND PL_ID = #{plId}
      </if>
      <if test="prodNo != null and prodNo != ''">
        AND PROD_NO LIKE '%' || #{prodNo} || '%'
      </if>
      <if test="dateFrom != null">
        AND PRO_DATE &gt;= #{dateFrom}
      </if>
      <if test="dateTo != null">
        AND PRO_DATE &lt;= #{dateTo}
      </if>
    </where>
    ORDER BY PRO_DATE DESC, PL_DET_ID DESC
  </select>

  <select id="countPlanDetails"
          parameterType="map"
          resultType="int">
    SELECT COUNT(1)
    FROM PRODUCT_PLAN_DETAIL
    <where>
      <if test="plId != null">
        AND PL_ID = #{plId}
      </if>
      <if test="prodNo != null and prodNo != ''">
        AND PROD_NO LIKE '%' || #{prodNo} || '%'
      </if>
      <if test="dateFrom != null">
        AND PRO_DATE &gt;= #{dateFrom}
      </if>
      <if test="dateTo != null">
        AND PRO_DATE &lt;= #{dateTo}
      </if>
    </where>
  </select>

  <!-- 우측: REQ_MAT + MATERIAL 조인 (자재명 포함) -->
  <select id="selectReqMatWithMaterialByPlDetId"
          parameterType="long"
          resultType="com.yedam.scm.vo.ReqMatVO">
    SELECT
      r.REQ_ID      AS reqId,
      r.MAT_ID      AS matId,
      r.PL_DET_ID   AS plDetId,
      r.REQ_WEIGHT  AS reqWeight,
      m.MAT_NAME    AS matName,
      m.UNIT        AS unit
    FROM REQ_MAT r
    LEFT JOIN MATERIAL m ON m.MAT_ID = r.MAT_ID
    WHERE r.PL_DET_ID = #{plDetId}
    ORDER BY r.REQ_ID ASC
  </select>

</mapper>
