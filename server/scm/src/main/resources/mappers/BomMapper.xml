<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yedam.scm.master.mapper.BomMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="BomResultMap" type="com.yedam.scm.vo.BomVO">
    <id property="bomId" column="BOM_ID"/>
    <result property="bomVersion" column="BOM_VERSION"/>
    <result property="prodId" column="PROD_ID"/>
    <result property="matId" column="MAT_ID"/>
    <result property="qty" column="QTY"/>
    <result property="createdAt" column="CREATED_AT"/>
    <result property="effectiveDate" column="EFFECTIVE_DATE"/>
    <result property="expireDate" column="EXPIRE_DATE"/>

    <!-- BOM_DETAIL -->
    <association property="bomDetail" javaType="com.yedam.scm.vo.BomDetailVO">
        <id property="bomDeId" column="BOM_DE_ID"/>
        <result property="mixingRate" column="MIXING_RATE"/>
        <result property="baseUnit" column="BASE_UNIT"/>
    </association>

    <!-- PRODUCT -->
    <association property="product" javaType="com.yedam.scm.vo.ProductVO">
        <id property="prodId" column="P_PROD_ID"/>
        <result property="prodName" column="P_PROD_NAME"/>
        <result property="spec" column="P_SPEC"/>
        <result property="unit" column="P_UNIT"/>
        <result property="createdAt" column="P_CREATED_AT"/>
    </association>

    <!-- MATERIAL -->
    <association property="material" javaType="com.yedam.scm.vo.MaterialVO">
        <id property="matId" column="M_MAT_ID"/>
        <result property="matName" column="M_MAT_NAME"/>
        <result property="matType" column="M_MAT_TYPE"/>
        <result property="matStoreCond" column="M_MAT_STORE_COND"/>
        <result property="matUnitConv" column="M_MAT_UNIT_CONV"/>
        <result property="matUnitPrice" column="M_MAT_UNIT_PRICE"/>
        <result property="leadTime" column="M_LEAD_TIME"/>
        <result property="safeStock" column="M_SAFE_STOCK"/>
        <result property="status" column="M_STATUS"/>
        <result property="spec" column="M_SPEC"/>
        <result property="unit" column="M_UNIT"/>
    </association>
</resultMap>


    <!-- BOM 조회 (BOM + PRODUCT + MATERIAL + BOM_DETAIL) -->
<select id="getBomByProdId" resultMap="BomResultMap" parameterType="string">
    SELECT 
        b.BOM_ID, 
        b.BOM_VERSION, 
        b.EFFECTIVE_DATE, 
        b.EXPIRE_DATE,
        b.PROD_ID, 
        b.MAT_ID, 
        b.CREATED_AT, 
        b.QTY,

        --  BOM_DETAIL
        bd.BOM_DE_ID ,
        bd.MIXING_RATE ,
        bd.BASE_UNIT ,

        --  PRODUCT
        p.PROD_ID   AS P_PROD_ID,
        p.PROD_NAME AS P_PROD_NAME,
        p.SPEC      AS P_SPEC,
        p.UNIT      AS P_UNIT,
        p.CREATED_AT AS P_CREATED_AT,

        --  MATERIAL
        m.MAT_ID    AS M_MAT_ID,
        m.MAT_NAME  AS M_MAT_NAME,
        m.MAT_TYPE  AS M_MAT_TYPE,
        m.MAT_STORE_COND AS M_MAT_STORE_COND,
        m.MAT_UNIT_CONV  AS M_MAT_UNIT_CONV,
        m.MAT_UNIT_PRICE AS M_MAT_UNIT_PRICE,
        m.LEAD_TIME      AS M_LEAD_TIME,
        m.SAFE_STOCK     AS M_SAFE_STOCK,
        m.STATUS         AS M_STATUS,
        m.SPEC           AS M_SPEC,
        m.UNIT           AS M_UNIT

    FROM BOM b
    JOIN BOM_DETAIL bd 
        ON b.BOM_ID = bd.BOM_ID        --  BOM_DETAIL 조인
    LEFT JOIN MATERIAL m 
        ON bd.MAT_ID = m.MAT_ID        --  자재는 DETAIL의 MAT_ID 기준
    LEFT JOIN PRODUCT p 
        ON b.PROD_ID = p.PROD_ID

    WHERE b.PROD_ID = #{prodId}
    ORDER BY b.BOM_VERSION, bd.BOM_DE_ID
</select>
<!-- BOM 등록 -->
    <insert id="insertBom" parameterType="com.yedam.scm.vo.BomVO">
        INSERT INTO BOM (BOM_ID, BOM_VERSION, EFFECTIVE_DATE, EXPIRE_DATE, PROD_ID, MAT_ID, CREATED_AT, MIXING_RATE)
        VALUES (next_code('BOM'), #{bomVersion}, #{effectiveDate}, #{expireDate}, #{prodId}, #{matId}, #{createdAt}, #{mixingRate})
    </insert>

    <!-- BOM 수정 -->
    <update id="updateBom" parameterType="com.yedam.scm.vo.BomVO">
        UPDATE BOM
        SET MAT_ID = #{matId},
            MIXING_RATE = #{mixingRate},
            EFFECTIVE_DATE = #{effectiveDate},
            EXPIRE_DATE = #{expireDate}
        WHERE BOM_ID = #{bomId}
    </update>

    <!-- BOM 삭제 -->
    <delete id="deleteBom" parameterType="string">
        DELETE FROM BOM WHERE BOM_ID = #{bomId}
    </delete>


</mapper>
