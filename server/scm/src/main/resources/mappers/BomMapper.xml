<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yedam.scm.master.mapper.BomMapper">

  <!-- =======================
       ResultMap
  ======================== -->
  <resultMap id="BomMap" type="com.yedam.scm.vo.BomVO">
    <id property="bomId" column="BOM_ID"/>
    <result property="prodId" column="PROD_ID"/>
    <result property="bomVersion" column="BOM_VERSION"/>
    <result property="effectiveDate" column="EFFECTIVE_DATE"/>
    <result property="expireDate" column="EXPIRE_DATE"/>
    <result property="lossRate" column="LOSS_RATE"/>
    <result property="lastUpdateDate" column="LAST_UPDATE_DATE"/>

    <collection property="details" ofType="com.yedam.scm.vo.BomDetailVO" resultMap="BomDetailMap"/>
  </resultMap>

  <resultMap id="BomDetailMap" type="com.yedam.scm.vo.BomDetailVO">
    <id property="bomDeId" column="BOM_DE_ID"/>
    <result property="bomId" column="BOM_ID"/>
    <result property="mixingRate" column="MIXING_RATE"/>
    <result property="qty" column="QTY"/>
    <result property="baseUnit" column="BASE_UNIT"/>
    <association property="material" javaType="com.yedam.scm.vo.MaterialVO">
      <result property="matId" column="MAT_ID"/>
      <result property="matName" column="MAT_NAME"/>
      <result property="unit" column="MAT_UNIT"/>
    </association>
  </resultMap>
  

  <!-- =======================
       SELECT
  ======================== -->
  <select id="getBomListByProdId" resultMap="BomMap" parameterType="string">
    SELECT 
    b.BOM_ID,
    b.BOM_VERSION,
    b.EFFECTIVE_DATE,
    b.EXPIRE_DATE,
    b.PROD_ID,
    b.LOSS_RATE,
    b.LAST_UPDATE_DATE,
    d.BOM_DE_ID,
    d.MIXING_RATE,
    d.QTY,
    d.BASE_UNIT,
    m.MAT_ID,
    m.MAT_NAME,
    m.UNIT AS MAT_UNIT
  FROM BOM b
  LEFT JOIN BOM_DETAIL d ON b.BOM_ID = d.BOM_ID
  LEFT JOIN MATERIAL m ON d.MAT_ID = m.MAT_ID
  WHERE b.PROD_ID = #{prodId}
  ORDER BY b.BOM_ID, d.BOM_DE_ID

  </select>

  <!-- =======================
       INSERT
  ======================== -->
  <insert id="insertBom" parameterType="com.yedam.scm.vo.BomVO">
  <selectKey keyProperty="bomId" order="BEFORE" resultType="string">
    SELECT next_code('BOM') FROM DUAL
  </selectKey>
    INSERT INTO BOM (
      BOM_ID,
      BOM_VERSION,
      PROD_ID,
      EFFECTIVE_DATE,
      EXPIRE_DATE,
      CREATED_AT,
      LOSS_RATE
    )
    VALUES (
      #{bomId},
      NVL(#{bomVersion}, 1),
      #{prodId},
      #{effectiveDate},
      #{expireDate},
      SYSDATE,
      NVL(#{lossRate}, 1)
    )
  </insert>

  <insert id="insertBomDetail" parameterType="com.yedam.scm.vo.BomDetailVO">
    INSERT INTO BOM_DETAIL (
      BOM_DE_ID,
      BOM_ID,
      MAT_ID,
      MIXING_RATE,
      QTY,
      BASE_UNIT
    )
    VALUES (
      next_code('BOMD'),
      #{bomId},
      #{matId},
      #{mixingRate},
      #{qty},
      #{baseUnit}
    )
  </insert>

  <!-- =======================
       UPDATE
  ======================== -->
  <update id="updateBom" parameterType="com.yedam.scm.vo.BomVO">
    UPDATE BOM
    SET 
      EFFECTIVE_DATE = #{effectiveDate},
      EXPIRE_DATE = #{expireDate},
      LAST_UPDATE_DATE = SYSDATE
    WHERE BOM_ID = #{bomId}
  </update>

  <update id="updateBomDetail" parameterType="com.yedam.scm.vo.BomDetailVO">
    UPDATE BOM_DETAIL
    SET 
      MAT_ID = #{matId},
      MIXING_RATE = #{mixingRate},
      QTY = #{qty},
      BASE_UNIT = #{baseUnit}
    WHERE BOM_DE_ID = #{bomDeId}
  </update>

  <!-- =======================
       DELETE
  ======================== -->
  <delete id="deleteBom">
    DELETE FROM BOM WHERE BOM_ID = #{bomId}
  </delete>

  <delete id="deleteBomDetailsByBomId">
    DELETE FROM BOM_DETAIL WHERE BOM_ID = #{bomId}
  </delete>

</mapper>
