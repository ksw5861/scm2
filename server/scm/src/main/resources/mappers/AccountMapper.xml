<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yedam.scm.master.mapper.AccountMapper">

  <!-- 공통 조건 분리 -->
  <sql id="accountConditions">
    <if test="condition.code != null and condition.code != ''">
      AND a.code LIKE '%' || #{condition.code} || '%'
    </if>

    <if test="condition.name != null and condition.name != ''">
      AND a.name LIKE '%' || #{condition.name} || '%'
    </if>

    <if test="condition.email != null and condition.email != ''">
      AND a.email LIKE '%' || #{condition.email} || '%'
    </if>

    <if test="condition.phone != null and condition.phone != ''">
      AND a.phone LIKE '%' || #{condition.phone} || '%'
    </if>

    <if test="condition.isActive != null and condition.isActive.size() > 0">
      AND a.is_active IN
      <foreach item="active" collection="condition.isActive" open="(" separator="," close=")">
        #{active}
      </foreach>
    </if>

    <if test="condition.type != null and condition.type.size() > 0">
      AND a.division IN
      <foreach item="div" collection="condition.type" open="(" separator="," close=")">
        #{div}
      </foreach>
    </if>
  </sql>

  <!-- 계정 목록 총 개수 -->
  <select id="selectAccountCountByCondition" resultType="long">
    SELECT COUNT(*)
    FROM account a
    WHERE 1 = 1
    <include refid="accountConditions"/>
  </select>

  <!-- 계정 목록 조회 -->
  <select id="selectAccountListByCondition" resultType="AccountVO">
    SELECT
      *
    FROM (
      SELECT 
        a.account_id      AS accountId,
        a.code            AS code,
        a.name            AS name,
        a.phone           AS phone,
        a.email           AS email,
        a.created_at      AS createdAt,
        a.division        AS division,
        a.is_active       AS isActive,
        ROW_NUMBER() OVER (ORDER BY a.account_id DESC) AS rn
      FROM account a
      WHERE 1 = 1
      <include refid="accountConditions"/>
    )
    WHERE rn BETWEEN #{paging.startRow} AND #{paging.endRow}
  </select>

  <update id="updateUseYnByAccountId">
    UPDATE account
    SET is_active = #{isActive}
    WHERE account_id = #{accountId}
  </update>

  <update id="setPassword">
    UPDATE account
    SET 
      password_hash = #{password},
      temp_password = 'Y'
    WHERE account_id = #{accountId}
  </update>


  <select id="getEmail" resultType="String">
    SELECT email
    FROM account
    WHERE account_id = #{accountId}
  </select>

</mapper>
