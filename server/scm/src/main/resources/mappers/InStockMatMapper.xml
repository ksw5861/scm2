<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yedam.scm.instockMat.mapper.InStockMatMapper">

<resultMap id="inboundResultMap" type="InboundVO">
    <id     property="inboundId"      column="INBOUND_ID"/>
    <result property="inboundNo"      column="INBOUND_NO"/>
    <result property="vendorOutDate"  column="VENDOR_OUT_DATE"/>
    <result property="venName"        column="VEN_NAME"/>
    <result property="inboundStatus"  column="INBOUND_STATUS"/>
    <result property="vendorId"       column="VENDOR_ID"/>
    <result property="venOutNo"       column="VEN_OUT_NO"/>
    <result property="rejMemo"        column="REJ_MEMO"/>
    <result property="unloadEmp"      column="UNLOAD_EMP"/>
    <result property="unloadDate"     column="UNLOAD_DATE"/>

    <association property="shipmentInfoVO" resultMap="com.yedam.scm.common.CommonMapper.ShipmentInfoMap"/>
    <association property="vendorVO" resultMap="com.yedam.scm.common.CommonMapper.VendorMap"/>
    <collection property="details" resultMap="inboundDetailResultMap"/>
</resultMap>

<resultMap id="inboundDetailResultMap" type="InboundDetailVO">
    <id     property="inboundDetId" column="INBOUND_DET_ID"/>
    <result property="inQty"        column="IN_QTY"/>
    <result property="inboundStatus" column="INBOUND_STATUS"/>
    <result property="inboundId"    column="INBOUND_ID"/>
    <result property="purId"        column="PUR_ID"/>
    <result property="inTotalQty"   column="IN_TOTAL_QTY"/>
    <result property="matId"        column="MAT_ID"/>
    <result property="vendorId"     column="VENDOR_ID"/>
    <result property="outQty"       column="OUT_QTY"/>
    <result property="purStatusId"  column="PUR_STATUS_ID"/>

    <association property="inboundLogVO" resultMap="InboundLogMap"/>
    <association property="materialVO" resultMap="com.yedam.scm.common.CommonMapper.MaterialMap"/>
</resultMap>

<resultMap id="InboundLogMap" type="InboundLogVO">
    <id     property="inLogId"        column="IN_LOG_ID" />
    <result property="inboundDetId"   column="INBOUND_DET_ID" />
    <result property="logInQty"       column="LOG_IN_QTY" />
    <result property="logInboundStatus"   column="LOG_INBOUND_STATUS" />
    <result property="reDate"         column="RE_DATE" />
    <result property="logName"        column="LOG_NAME" />
    <result property="logResult"      column="LOG_RESULT" />
    <result property="logImg"         column="LOG_IMG" />
    <result property="logRejQty"      column="LOG_REJ_QTY" />
    <result property="logMemo"        column="LOG_MEMO" />
    <result property="logExpDate"     column="LOG_EXP_DATE" />
</resultMap>

<resultMap id="matlotMap" type="MatLotVO">
    <id property="lotId" column="LOT_ID"/>
    <result property="matId" column="MAT_ID"/>
    <result property="lotNo" column="LOT_NO"/>
    <result property="regDate" column="REG_DATE"/>
    <result property="initQty" column="INIT_QTY"/>
    <result property="currQty" column="CURR_QTY"/>
    <result property="expDate" column="EXP_DATE"/>
    <result property="warehouse" column="WAREHOUSE"/>
    <result property="empName" column="EMP_NAME"/>
    <result property="lotStatus" column="LOT_STATUS"/>
    <result property="inboundDetId" column="INBOUND_DET_ID"/>
    <result property="initWeight" column="INIT_WEIGHT"/>
    <result property="currWeight" column="CURR_WEIGHT"/>

    <association property="materialVO" resultMap="com.yedam.scm.common.CommonMapper.MaterialMap"/>
</resultMap>

<!--입고마스터T 출력-->
<select id ="getVenShipList" resultMap="inboundResultMap">
SELECT * FROM (
    SELECT a.*, ROWNUM rnum
    FROM (
            SELECT i.inbound_id,
                i.ven_name,
                i.vendor_out_date,
                v.company_name,
                i.ven_out_no,
                i.inbound_status
            FROM inbound i
            JOIN vendor v
            ON i.vendor_id = v.vendor_id
            WHERE 1=1
          AND i.inbound_status = 'm1'

          <if test="search.startDate != null">
            AND i.vendor_out_date &gt;= #{search.startDate}
          </if>
          <if test="search.endDate != null">
            AND i.vendor_out_date &lt;= #{search.endDate} + 1
          </if>
          <if test="search.vendorName != null and search.vendorName != ''">
            AND v.company_name LIKE '%' || #{search.vendorName} || '%'
          </if>
        ORDER BY i.vendor_out_date DESC
    ) a
    WHERE ROWNUM &lt;= #{page.endRow}
)
WHERE rnum &gt;= #{page.startRow}
</select>

<!--입고마스터T 데이터 count-->
<select id="getVenShipListCount" resultType="long">
SELECT count(DISTINCT inbound_id)
FROM inbound i
JOIN vendor v
ON i.vendor_id = v.vendor_id
WHERE 1=1
  AND i.inbound_status = 'm1'
  <if test="search.startDate != null">
    AND .vendor_out_date &gt;= #{search.startDate}
  </if>
  <if test="search.endDate != null">
    AND i.vendor_out_date &lt;= #{search.endDate} + 1
  </if>
  <if test="search.vendorName != null and search.vendorName != ''">
    AND v.company_name LIKE '%' || #{search.vendorName} || '%'
  </if>
</select>

<!--입고상세T 출력-->
<select id ="getVenShipDetailList" parameterType = "long" resultMap ="inboundDetailResultMap">
SELECT id.inbound_det_id,
       id.pur_id,
       id.mat_id,
       m.mat_name,
       m.unit,
       id.out_qty,
       id.pur_status_id
FROM inbound_detail id
JOIN material m
ON id.mat_id = m.mat_id
WHERE id.inbound_id = #{inboundId}
</select>

<!--하차등록-->
<select id="callApproveUnload" statementType="CALLABLE">
    {call PROC_APPROVE_UNLOAD(
        #{inboundId, mode=IN, jdbcType=NUMERIC},
        #{unloadEmp,  mode=IN, jdbcType=VARCHAR}
     )}
</select>

<!--하차반품-->
<select id="callUnloadReturn" statementType="CALLABLE">
    {call PROC_UNLOAD_RETURN(
        #{inboundId, mode=IN, jdbcType=NUMERIC},
        #{unloadEmp,  mode=IN, jdbcType=VARCHAR},
        #{rejMemo, mode=IN, jdbcType=VARCHAR}
     )}
</select>

<!--입고대기목록-->
<select id="getApproveUnload" resultMap="inboundResultMap">
SELECT * FROM (
  SELECT a.*, ROWNUM rnum
  FROM (
    SELECT i.inbound_id,
           i.inbound_no,
           i.unload_date,
           i.unload_emp,
           i.inbound_status,
           v.company_name
    FROM inbound i
    JOIN vendor v ON i.vendor_id = v.vendor_id
    WHERE 1=1
      AND i.inbound_status IN ('app', 'm2')
      <if test="search.startDate != null">
        AND i.unload_date &gt;= #{search.startDate}
      </if>
      <if test="search.endDate != null">
        AND i.unload_date &lt;= #{search.endDate} + 1
      </if>
      <if test="search.vendorName != null and search.vendorName != ''">
        AND v.company_name LIKE '%' || #{search.vendorName} || '%'
      </if>
      <if test="search.status != null and search.status != ''">
        AND i.inbound_status LIKE '%' || #{search.status} || '%'
      </if>
    ORDER BY i.unload_date DESC
  ) a
  WHERE ROWNUM &lt;= #{page.endRow}
)
WHERE rnum &gt;= #{page.startRow}
</select>

<!--입고대기목록데이터 수-->
<select id="getApproveUnloadListCount" resultType="long">
SELECT count(DISTINCT inbound_id)
FROM inbound i
JOIN vendor v ON i.vendor_id = v.vendor_id
WHERE 1=1
AND i.inbound_status IN ('app', 'm2')
<if test="search.startDate != null">
  AND i.unload_date &gt;= #{search.startDate}
</if>
<if test="search.endDate != null">
  AND i.unload_date &lt;= #{search.endDate} + 1
</if>
<if test="search.vendorName != null and search.vendorName != ''">
  AND v.company_name LIKE '%' || #{search.vendorName} || '%'
</if>
<if test="search.status != null and search.status != ''">
  AND i.inbound_status LIKE '%' || #{search.status} || '%'
</if>
</select>

<!--입고대기목록상세-->
<select id = "getApproveUnloadDetailList" parameterType = "long" resultMap ="inboundDetailResultMap">
SELECT id.inbound_det_id,
       id.pur_id,
       id.mat_id,
       m.mat_name,
       m.stock_unit,
       id.out_qty,
       id.pur_status_id,
       id.in_total_qty
FROM inbound_detail id
JOIN material m
ON id.mat_id = m.mat_id
WHERE id.inbound_id = #{inboundId}
AND id.inbound_status in ('d6', 'd3')
</select>

<!--입고등록-->
<update id="callMatInboundStock" parameterType="InboundDetailVO" statementType="CALLABLE">
    { call PROC_MAT_INBOUND_STOCK  (
        #{inboundDetId,      mode=IN, jdbcType=NUMERIC},
        #{inboundId,         mode=IN, jdbcType=NUMERIC},
        #{inQty,             mode=IN, jdbcType=NUMERIC},
        #{inboundLogVO.logName,    mode=IN, jdbcType=VARCHAR},
        #{inboundLogVO.logExpDate, mode=IN, jdbcType=DATE}
      )
    }
</update>

<!--불량등록[1)정보등록  2)불량정보등록 시퀀스아이디get 3)이미지첨부여부에 따른 이미지 등록]-->
<select id="callRegMatDefect" parameterType="map" statementType="CALLABLE">
{ call PROC_REGISTER_DEFECT(
        #{inboundDetId, mode=IN, jdbcType=NUMERIC},   
        #{logRejQty,   mode=IN, jdbcType=NUMERIC},
        #{logMemo,     mode=IN, jdbcType=VARCHAR},     
        #{logName,     mode=IN, jdbcType=VARCHAR},
        #{logId,       mode=OUT, jdbcType=NUMERIC}    
) }
</select>

<!-- <select id="selectRecentSeq" resultType="long">
SELECT SEQ_INBOUND_LOG.CURRVAL FROM dual
</select> -->

<update id="updateDefectImagePath" parameterType="InboundLogVO">
UPDATE inbound_log
SET log_img = #{logImg}
WHERE in_log_id = #{inLogId}
</update>

<!--재고현황-->
<select id="getMatStockList" resultMap="matlotMap">
SELECT * FROM (
    SELECT a.*, ROWNUM rnum
    FROM (
        SELECT
          ml.mat_id,
          m.mat_name,
          SUM(ml.curr_weight) AS curr_weight,
          m.unit,
          SUM(ml.curr_qty) AS curr_qty,
          m.stock_unit
        FROM mat_lot ml
        JOIN material m ON ml.mat_id = m.mat_id
        WHERE 1=1
        AND lot_status IN ('OPEN', 'USING')
        <if test="materialId != null and materialId != ''">
            AND UPPER(m.mat_id) LIKE '%' || UPPER(#{materialId}) || '%'
        </if>
        <if test="materialName != null and materialName != ''">
            AND UPPER(m.mat_name) LIKE '%' || UPPER(#{materialName}) || '%'
        </if>
        <if test="lotNo != null and lotNo != ''">
            AND UPPER(ml.lot_no) LIKE '%' || UPPER(#{lotNo}) || '%'
        </if>
        <if test="lotStatus != null and lotStatus != ''">
            AND ml.lot_status = #{lotStatus}
        </if>
        GROUP BY ml.mat_id, m.mat_name, m.unit, m.stock_unit
        ORDER BY ml.mat_id
    ) a
    WHERE ROWNUM &lt;= #{endRow}
)
WHERE rnum &gt;= #{startRow}
</select>
<!--총 데이터수-->
<select id="getMatStockCount" resultType="long">
SELECT COUNT(DISTINCT ml.mat_id)
FROM mat_lot ml
JOIN material m ON ml.mat_id = m.mat_id
WHERE 1=1
<if test="materialId != null and materialId != ''">
    AND UPPER(m.mat_id) LIKE '%' || UPPER(#{materialId}) || '%'
</if>
<if test="materialName != null and materialName != ''">
    AND UPPER(m.mat_name) LIKE '%' || UPPER(#{materialName}) || '%'
</if>
<if test="lotNo != null and lotNo != ''">
    AND UPPER(ml.lot_no) LIKE '%' || UPPER(#{lotNo}) || '%'
</if>
<if test="lotStatus != null and lotStatus != ''">
    AND ml.lot_status = #{lotStatus}
</if>
</select>

<!--자재별 LOT현황-->
<select id="getMatLotList" resultMap="matlotMap">
SELECT ml.lot_id,
       ml.lot_no,
       m.mat_name,
       ml.curr_weight,
       m.unit,
       ml.curr_qty,
       m.stock_unit,
       ml.reg_date,
       ml.warehouse,
       ml.exp_date,
       ml.lot_status
FROM mat_lot ml
JOIN material m
ON ml.mat_id = m.mat_id
WHERE ml.mat_id = #{matId}
AND lot_status IN ('OPEN', 'USING')
ORDER BY ml.lot_id
</select>

<!--재고조정등록-->
<select id="callProcAdjustStock" statementType="CALLABLE" parameterType="com.yedam.scm.vo.MatLotStockAdjVO">
    { call PROC_MAT_ADJUST_STOCK(
        #{lotId, mode=IN, jdbcType=NUMERIC},
        #{inOut, mode=IN, jdbcType=VARCHAR},
        #{weight, mode=IN, jdbcType=NUMERIC},
        #{reason, mode=IN, jdbcType=VARCHAR},
        #{name, mode=IN, jdbcType=VARCHAR},
        #{adjStockId, mode=OUT, jdbcType=NUMERIC}
      ) }
</select>
<!--조정이력-->
<select id="selectAdjustHistoryByLotId" parameterType="long" resultType="com.yedam.scm.vo.MatLotStockAdjVO">
SELECT adj_stock_id, 
        re_date, 
        in_out,
        weight,
        before_weight, 
        after_weight,
        name, reason,
        lot_id
FROM mat_lotstock_adj
WHERE lot_id = #{lotId}
 ORDER BY re_date DESC
</select>

</mapper>