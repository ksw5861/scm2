<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yedam.scm.master.mapper.VendorMapper">

  <!-- 공통 조건 블록 -->
  <sql id="vendorConditions">
    <if test="condition.type != null and condition.type.size() > 0">
      AND (
        <foreach item="st" collection="condition.type" separator=" OR ">
          <choose>
            <when test="st == 0">
              type IN (0, 2)
            </when>
            <when test="st == 1">
              type IN (1, 2)
            </when>
            <otherwise>
              type = #{st}
            </otherwise>
          </choose>
        </foreach>
      )
    </if>

    <if test="condition.isActive != null and condition.isActive.size() > 0">
      AND is_active IN
      <foreach item="st" collection="condition.isActive" open="(" separator="," close=")">
        #{st}
      </foreach>
    </if>

    <if test="condition.companyName != null and condition.companyName != ''">
      AND company_name LIKE '%' || #{condition.companyName} || '%'
    </if>

    <if test="condition.name != null and condition.name != ''">
      AND (
        ceo_name LIKE '%' || #{condition.name} || '%'
        OR owner_name LIKE '%' || #{condition.name} || '%'
      )
    </if>

    <if test="condition.phoneNumber != null and condition.phoneNumber != ''">
      AND (
        REPLACE(phone_number, '-', '') LIKE '%' || REPLACE(#{condition.phoneNumber}, '-', '') || '%'
        OR REPLACE(owner_tel, '-', '') LIKE '%' || REPLACE(#{condition.phoneNumber}, '-', '') || '%'
      )
    </if>

    <if test="condition.businessRegistration != null and condition.businessRegistration != ''">
      AND REPLACE(business_registration, '-', '') LIKE '%' || REPLACE(#{condition.businessRegistration}, '-', '') || '%'
    </if>
  </sql>

  <!-- 거래처 목록 조회 -->
  <select id="getVendorList" resultType="VendorVO">
    SELECT 
      e.type,
      e.company_name,
      e.business_registration,
      e.vendor_id
    FROM (
      SELECT 
        type,
        company_name,
        business_registration,
        vendor_id,
        ROW_NUMBER() OVER (ORDER BY vendor_id DESC) AS rn
      FROM vendor
      WHERE 1 = 1
      <include refid="vendorConditions"/>
    ) e
    WHERE e.rn BETWEEN #{paging.startRow} AND #{paging.endRow}
  </select>

  <!-- 거래처 목록 카운트 -->
  <select id="getVendorListTotalCount" resultType="Long">
    SELECT count(*)
    FROM vendor
    WHERE 1 = 1
    <include refid="vendorConditions"/>
  </select>

  <!-- 거래처 상세 조회 -->
  <select id="getVendorDetail" parameterType="string" resultType="VendorVO">
    SELECT *
    FROM vendor
    WHERE vendor_id = #{vendorId}
  </select>

  <!-- 거래처 등록 -->
  <insert id="insertVendor" parameterType="VendorVO" statementType="CALLABLE">
    { CALL insert_vendor_with_account(
      #{vendorId, mode=OUT, jdbcType=VARCHAR},
      #{businessRegistration, mode=IN, jdbcType=VARCHAR},
      #{companyName, mode=IN, jdbcType=VARCHAR},
      #{ceoName, mode=IN, jdbcType=VARCHAR},
      #{phoneNumber, mode=IN, jdbcType=VARCHAR},
      #{address, mode=IN, jdbcType=VARCHAR},
      #{isActive, mode=IN, jdbcType=CHAR},
      #{type, mode=IN, jdbcType=VARCHAR},
      #{ownerName, mode=IN, jdbcType=VARCHAR},
      #{ownerEmail, mode=IN, jdbcType=VARCHAR},
      #{ownerTel, mode=IN, jdbcType=VARCHAR},
      #{tempPassword, mode=IN, jdbcType=VARCHAR},
      #{rowCount, mode=OUT, jdbcType=NUMERIC, javaType=java.lang.Integer}
    ) }
  </insert>


  <!-- 거래처 수정 -->
  <update id="updateVendor" parameterType="VendorVO" statementType="CALLABLE">
    { CALL update_vendor_with_account(
      #{vendorId, mode=IN, jdbcType=VARCHAR},
      #{businessRegistration, mode=IN, jdbcType=VARCHAR},
      #{companyName, mode=IN, jdbcType=VARCHAR},
      #{ceoName, mode=IN, jdbcType=VARCHAR},
      #{phoneNumber, mode=IN, jdbcType=VARCHAR},
      #{address, mode=IN, jdbcType=VARCHAR},
      #{isActive, mode=IN, jdbcType=CHAR},
      #{type, mode=IN, jdbcType=VARCHAR},
      #{ownerName, mode=IN, jdbcType=VARCHAR},
      #{ownerEmail, mode=IN, jdbcType=VARCHAR},
      #{ownerTel, mode=IN, jdbcType=VARCHAR},
      #{rowCount, mode=OUT, jdbcType=NUMERIC, javaType=java.lang.Integer}
    ) }
  </update>

  <!-- 거래처 삭제 -->
  <delete id="deleteVendor" statementType="CALLABLE">
    { CALL delete_vendor_with_account(
      #{param.vendorId, mode=IN, jdbcType=VARCHAR},
      #{param.rowCount, mode=OUT, jdbcType=NUMERIC, javaType=java.lang.Integer}
    ) }
  </delete>

</mapper>
